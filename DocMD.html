<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerador de Documentos Markdown Avançado</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2c3e50;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #34495e;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: var(--dark-color);
      line-height: 1.6;
    }

    .app-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
    }

    .app-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--primary-color);
    }

    .app-title {
      color: var(--primary-color);
      font-weight: 600;
    }

    .app-subtitle {
      color: var(--secondary-color);
      font-size: 1.1rem;
    }

    .card {
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      border: none;
    }

    .card-header {
      background-color: var(--primary-color);
      color: white;
      border-radius: 10px 10px 0 0 !important; /* Override accordion border */
      padding: 1rem;
      font-weight: 600;
    }

    /* Accordion Styling */
    .accordion-item {
        border-radius: 10px !important;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-bottom: 2rem; /* Same margin as cards */
        overflow: hidden; /* Ensures rounded corners apply correctly */
    }
    .accordion-header {
         border-radius: 10px 10px 0 0 !important;
    }
     .accordion-button {
        background-color: var(--primary-color);
        color: white;
        font-weight: 600;
        border-radius: 10px 10px 0 0 !important;
        padding: 1rem;
     }
      .accordion-button:not(.collapsed) {
         background-color: var(--primary-color);
         color: white;
         box-shadow: none; /* Remove Bootstrap's default focus shadow */
      }
      .accordion-button.collapsed {
           border-radius: 10px !important; /* Rounded corners when collapsed */
      }
      .accordion-button:focus {
          box-shadow: none;
          border-color: rgba(0,0,0,.125);
      }
      /* Arrow color */
       .accordion-button::after {
          background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23ffffff'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
       }
       .accordion-button:not(.collapsed)::after {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23ffffff'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
            transform: rotate(-180deg);
       }
       .accordion-body {
           padding: 1.5rem; /* More padding for content */
           background-color: white;
       }


    .form-label {
      font-weight: 500;
      color: var(--secondary-color);
    }

    .form-control, .form-select {
      border-radius: 6px;
      border: 1px solid #ced4da;
      padding: 0.6rem 0.75rem;
      transition: all 0.3s;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
    }

    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      padding: 0.6rem 1.5rem;
      font-weight: 500;
      border-radius: 6px;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      background-color: #2980b9;
      border-color: #2980b9;
    }

    .btn-secondary {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
    }

    .btn-secondary:hover {
      background-color: #1a252f;
      border-color: #1a252f;
    }

    #preview {
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 2rem;
      background-color: white;
      min-height: 300px;
    }

    .hidden {
      display: none;
    }

    .info-icon {
      color: var(--primary-color);
      cursor: pointer;
      margin-left: 0.5rem;
    }

    .format-badge {
      display: inline-block;
      background-color: #e9f7fe;
      color: var(--primary-color);
      border-radius: 4px;
      padding: 0.2rem 0.5rem;
      font-size: 0.85rem;
      margin: 0.2rem;
      border: 1px solid #c9e7fe;
    }

     .format-badge.op-badge { /* Style for operations/pre-fillers */
      background-color: #e8f5e9; /* Light green */
      color: #2e7d32; /* Darker green */
      border: 1px solid #c8e6c9;
    }

    .format-example {
      font-family: monospace;
      background-color: #f8f9fa;
      padding: 0.5rem;
      border-radius: 4px;
      margin: 0.5rem 0;
      border-left: 3px solid var(--primary-color);
    }

    .file-upload-container {
      border: 2px dashed #ced4da;
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      background-color: #f8f9fa;
      transition: all 0.3s;
      cursor: pointer;
    }

    .file-upload-container:hover {
      border-color: var(--primary-color);
      background-color: #e9f7fe;
    }

    .upload-icon {
      font-size: 2.5rem;
      color: var(--primary-color);
      margin-bottom: 1rem;
    }

    .tooltip-inner {
      max-width: 350px;
    }

    .placeholder-list {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      border: 1px solid #dee2e6;
    }

    .placeholder-item {
      font-family: monospace;
      padding: 0.5rem;
      margin: 0.25rem 0;
      background-color: white;
      border-radius: 4px;
      border: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .placeholder-item:hover {
      background-color: #e9f7fe;
    }

    .copy-btn {
      background: none;
      border: none;
      color: var(--primary-color);
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .copy-btn:hover {
      background-color: var(--primary-color);
      color: white;
    }

    .placeholder-category {
      font-weight: 600;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      color: var(--secondary-color);
    }

    .placeholder-modal .modal-header {
      background-color: var(--primary-color);
      color: white;
    }

    .placeholder-modal .modal-body {
      max-height: 70vh;
      overflow-y: auto;
    }

    .placeholder-tabs .nav-link {
      color: var(--secondary-color);
    }

    .placeholder-tabs .nav-link.active {
      color: var(--primary-color);
      font-weight: 600;
      border-bottom: 2px solid var(--primary-color);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <h1 class="app-title">Gerador de Documentos Markdown Avançado</h1>
      <p class="app-subtitle">Crie documentos personalizados com formatação inteligente e datas pré-preenchidas</p>
    </header>

    <!-- MODIFICADO: Seção "Como funciona" agora é um Accordion -->
    <div class="accordion" id="howtoAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="howtoHeading">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#howtoCollapse" aria-expanded="false" aria-controls="howtoCollapse">
             <i class="fas fa-info-circle me-2"></i> Como funciona (Clique para expandir)
          </button>
        </h2>
        <div id="howtoCollapse" class="accordion-collapse collapse" aria-labelledby="howtoHeading" data-bs-parent="#howtoAccordion">
          <div class="accordion-body">
             <p>Esta ferramenta permite criar documentos a partir de templates Markdown. Placeholders como <code>[Campo]</code> ou <code>{[Campo].formato}</code> serão substituídos.</p>

             <h5 class="mt-4">Pré-preenchimento de Datas (Editável):</h5>
             <p>Use os seguintes formatos para pré-preencher campos com datas descritivas (ex: "16 de julho de 2024"), que podem ser alteradas pelo usuário antes de gerar o documento:</p>
             <div class="d-flex flex-wrap">
                 <span class="format-badge op-badge"><code>datahoje</code> - Pré-preenche com a data atual por extenso.</span>
                 <span class="format-badge op-badge"><code>datahoje.add(num[D|M|A])</code> - Pré-preenche com a data atual + dias (D), meses (M) ou anos (A), por extenso.</span>
             </div>
             <p class="mt-2"><small><strong>Exemplo:</strong> <code>{[Data Vencimento].datahoje.add(6M)}</code> irá preencher o campo "Data Vencimento" com a data daqui a 6 meses (ex: "16 de janeiro de 2025"). O usuário pode editar este valor.</small></p>
             <p><small><strong>Importante:</strong> O valor final usado no documento será o que estiver no campo no momento da geração.</small></p>

             <h5 class="mt-4">Formatações de Texto/Número (Aplicadas na Geração):</h5>
              <p>Estas formatações são aplicadas ao valor do campo *no momento da geração* do documento:</p>
             <div class="d-flex flex-wrap">
               <span class="format-badge"><code>maiusculo</code> - Converte para CAIXA ALTA</span>
               <span class="format-badge"><code>minusculo</code> - Converte para caixa baixa</span>
               <span class="format-badge"><code>capitalizado</code> - Primeira Letra Maiúscula</span>
               <span class="format-badge"><code>telefone</code> - Formata como (99) 99999-9999</span>
               <span class="format-badge"><code>cpf</code> - Formata como 999.999.999-99</span>
               <span class="format-badge"><code>cnpj</code> - Formata como 99.999.999/9999-99</span>
               <span class="format-badge"><code>cpfcnpj</code> - Detecta e formata CPF ou CNPJ</span>
               <span class="format-badge"><code>cep</code> - Formata como 99999-999</span>
               <span class="format-badge"><code>data</code> - Tenta formatar string como DD/MM/AAAA</span>
               <span class="format-badge"><code>moeda</code> - Formata como R$ 9.999,99</span>
               <span class="format-badge"><code>valorextenso</code> - Converte número para valor por extenso</span>
             </div>

             <h5 class="mt-4">Formatações múltiplas:</h5>
             <p>Você pode encadear formatações. Ex: <code>{[Valor].moeda.valorextenso}</code>. Se usar uma formatação após um pré-preenchimento de data (ex: <code>{[Data Vencimento].datahoje.add(1M).maiusculo}</code>), a formatação (<code>maiusculo</code>) será aplicada ao texto da data que estiver no campo no momento da geração.</p>

             <h5 class="mt-4">Textos de ajuda:</h5>
             <p>Adicione dicas aos campos: <code>{[CPF|Digite apenas os números].cpf}</code></p>

             <h5 class="mt-4">Exemplos:</h5>
             <div class="format-example">
               Prezado Sr. {[Nome do Cliente|Digite o nome completo].capitalizado},<br>
               CPF/CNPJ: {[Documento|Digite apenas os números].cpfcnpj}<br>
               Telefone: {[Telefone|Ex: 11999999999].telefone}<br>
               Valor total: {[Valor|Digite o valor em reais].moeda}<br>
               Valor por extenso: {[Valor].valorextenso}<br>
               Data de Emissão: {[Data Emissão].datahoje} <span class="text-muted small">(Pré-preenchido, editável)</span><br>
               Data de Vencimento (90 dias): {[Data Vencimento].datahoje.add(90D)} <span class="text-muted small">(Pré-preenchido, editável)</span><br>
               Próxima Renovação (1 ano): {[Data Renovacao].datahoje.add(1A)} <span class="text-muted small">(Pré-preenchido, editável)</span>
             </div>

             <div class="mt-4">
               <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#placeholderModal">
                 <i class="fas fa-list-ul me-2"></i> Mostrar Placeholders Disponíveis
               </button>
             </div>
          </div>
        </div>
      </div>
    </div>
    <!-- FIM Accordion -->

    <div class="card">
      <div class="card-header">
        <i class="fas fa-file-upload me-2"></i> Carregar Template Markdown
      </div>
      <div class="card-body">
        <div class="file-upload-container" id="dropArea">
          <i class="fas fa-cloud-upload-alt upload-icon"></i>
          <h5>Arraste e solte seu arquivo Markdown aqui</h5>
          <p class="text-muted">ou</p>
          <input type="file" id="fileInput" accept=".md" class="d-none">
          <button class="btn btn-primary" id="browseButton">
            <i class="fas fa-folder-open me-2"></i> Procurar arquivo
          </button>
        </div>
      </div>
    </div>

    <form id="formFields" class="hidden mt-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <i class="fas fa-edit me-2"></i> Preencher Campos
          </div>
          <div>
            <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#placeholderModal">
              <i class="fas fa-list-ul me-1"></i> Placeholders
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="dynamicFields"></div>

          <hr class="my-4">

          <div class="row">
            <div class="col-md-6">
              <label for="fontFamily" class="form-label">Fonte do documento:</label>
              <select id="fontFamily" class="form-select">
                <option value="Helvetica, Arial, sans-serif" selected>Helvetica</option>
                <option value="'Times New Roman', Times, serif">Times New Roman</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                <option value="'Courier New', Courier, monospace">Courier New</option>
              </select>
            </div>

            <div class="col-md-3">
              <label for="fontSize" class="form-label">Tamanho da fonte:</label>
              <select id="fontSize" class="form-select">
                <option value="12px">12px</option>
                <option value="14px">14px</option>
                <option value="16px" selected>16px</option>
                <option value="18px">18px</option>
                <option value="20px">20px</option>
              </select>
            </div>

            <div class="col-md-3">
              <label for="outputMode" class="form-label">Formato de saída:</label>
              <select id="outputMode" class="form-select">
                <option value="preview">Visualizar</option>
                <option value="print">Imprimir</option>
              </select>
            </div>
          </div>
        </div>
        <div class="card-footer text-end">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-file-alt me-2"></i> Gerar Documento
          </button>
        </div>
      </div>
    </form>

    <div id="previewContainer" class="mt-4 hidden">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <i class="fas fa-eye me-2"></i> Visualização do Documento
          </div>
          <div>
            <button id="printPreviewBtn" class="btn btn-sm btn-secondary">
              <i class="fas fa-print me-1"></i> Imprimir
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="preview"></div>
        </div>
      </div>
    </div>

    <!-- Modal de Placeholders (Estrutura HTML igual) -->
    <div class="modal fade placeholder-modal" id="placeholderModal" tabindex="-1" aria-labelledby="placeholderModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="placeholderModalLabel">
              <i class="fas fa-list-ul me-2"></i> Placeholders Disponíveis
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted">Placeholders são marcadores no seu template. Eles podem ser simples (substituídos pelo valor do campo), pré-preencher campos com datas editáveis, ou aplicar formatações no momento da geração.</p>
            <ul class="nav nav-tabs placeholder-tabs mb-3" id="placeholderTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="simple-tab" data-bs-toggle="tab" data-bs-target="#simple-placeholders" type="button" role="tab" aria-controls="simple-placeholders" aria-selected="true">Simples</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="formatted-tab" data-bs-toggle="tab" data-bs-target="#formatted-placeholders" type="button" role="tab" aria-controls="formatted-placeholders" aria-selected="false">Com Formatação / Pré-preenchimento</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-placeholder" type="button" role="tab" aria-controls="create-placeholder" aria-selected="false">Criar Novo</button>
              </li>
            </ul>

            <div class="tab-content" id="placeholderTabsContent">
              <!-- Placeholders Simples -->
              <div class="tab-pane fade show active" id="simple-placeholders" role="tabpanel" aria-labelledby="simple-tab">
                <p class="text-muted">Placeholders simples <code>[Nome do Campo]</code> ou <code>[Nome do Campo|Ajuda]</code>. Serão substituídos diretamente pelo valor digitado no campo.</p>
                <div id="simplePlaceholderList" class="placeholder-list">
                  <div class="text-center text-muted py-3" id="noSimplePlaceholders">
                    <i class="fas fa-info-circle me-2"></i> Nenhum placeholder simples encontrado.
                  </div>
                </div>
              </div>

              <!-- Placeholders com Formatação/Pré-preenchimento -->
              <div class="tab-pane fade" id="formatted-placeholders" role="tabpanel" aria-labelledby="formatted-tab">
                <p class="text-muted">Placeholders no formato <code>{[Nome Campo].operação}</code>. Veja a seção "Como funciona" para detalhes.</p>
                <div id="formattedPlaceholderList" class="placeholder-list">
                   <p class="placeholder-category">Pré-preenchimento de Data (Editável)</p>
                   <div id="dateOpsPlaceholderList"></div>
                   <p class="placeholder-category mt-3">Formatação de Texto/Número (Na Geração)</p>
                   <div id="textNumPlaceholderList"></div>
                  <div class="text-center text-muted py-3" id="noFormattedPlaceholders">
                    <i class="fas fa-info-circle me-2"></i> Nenhum placeholder com formatação/pré-preenchimento encontrado.
                  </div>
                </div>
              </div>

              <!-- Criar Novo Placeholder -->
              <div class="tab-pane fade" id="create-placeholder" role="tabpanel" aria-labelledby="create-tab">
                 <p class="text-muted">Crie um novo placeholder para usar no seu template. Note que formatações múltiplas complexas podem precisar ser montadas manualmente.</p>

                <div class="mb-3">
                  <label for="newPlaceholderName" class="form-label">Nome do Campo:</label>
                  <input type="text" class="form-control" id="newPlaceholderName" placeholder="Ex: Nome do Cliente">
                </div>

                <div class="mb-3">
                  <label for="newPlaceholderHelp" class="form-label">Texto de Ajuda (opcional):</label>
                  <input type="text" class="form-control" id="newPlaceholderHelp" placeholder="Ex: Digite o nome completo">
                </div>

                <div class="mb-3">
                  <label class="form-label">Tipo de Placeholder:</label>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="placeholderType" id="typePlain" value="plain" checked>
                    <label class="form-check-label" for="typePlain">
                      Simples <code>[Nome do Campo]</code>
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="placeholderType" id="typeFormatted" value="formatted">
                    <label class="form-check-label" for="typeFormatted">
                      Com Formatação / Pré-preenchimento <code>{[Nome Campo].operação}</code>
                    </label>
                  </div>
                </div>

                <div id="formatOptions" class="mb-3 d-none">
                  <label for="placeholderFormat" class="form-label">Operação / Formatação Primária:</label>
                  <select class="form-select" id="placeholderFormat">
                     <option value="">Selecione uma opção</option>
                     <option value="datahoje" data-type="prefill">datahoje - Pré-preenche data atual (editável)</option>
                     <option value="datahoje.add(30D)" data-type="prefill">datahoje.add(30D) - Pré-preenche hoje+30d (editável)</option>
                     <option value="datahoje.add(6M)" data-type="prefill">datahoje.add(6M) - Pré-preenche hoje+6m (editável)</option>
                     <option value="datahoje.add(1A)" data-type="prefill">datahoje.add(1A) - Pré-preenche hoje+1a (editável)</option>
                     <option value="maiusculo">maiusculo - CAIXA ALTA (na geração)</option>
                     <option value="minusculo">minusculo - caixa baixa (na geração)</option>
                     <option value="capitalizado">capitalizado - Primeira Maiúscula (na geração)</option>
                     <option value="telefone">telefone - (99) 99999-9999 (na geração)</option>
                     <option value="cpf">cpf - 999.999.999-99 (na geração)</option>
                     <option value="cnpj">cnpj - 99.999.999/9999-99 (na geração)</option>
                     <option value="cpfcnpj">cpfcnpj - CPF ou CNPJ (na geração)</option>
                     <option value="cep">cep - 99999-999 (na geração)</option>
                     <option value="data">data - DD/MM/AAAA (na geração)</option>
                     <option value="moeda">moeda - R$ 9.999,99 (na geração)</option>
                     <option value="valorextenso">valorextenso - Valor por extenso (na geração)</option>
                  </select>
                   <small class="form-text text-muted" id="formatNote">Para outras durações (ex: <code>add(45D)</code>), monte o placeholder manualmente no template.</small>
                </div>

                <div class="mb-3">
                  <label for="placeholderPreview" class="form-label">Prévia do Placeholder (para copiar):</label>
                  <div class="form-control bg-light" id="placeholderPreview" style="font-family: monospace;">[Nome do Campo]</div>
                </div>

                <button type="button" class="btn btn-primary" id="copyNewPlaceholder">
                  <i class="fas fa-copy me-2"></i> Copiar Placeholder para Template
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Inicialização de tooltips do Bootstrap
    document.addEventListener('DOMContentLoaded', function() {
      const initializeTooltips = () => {
        // Dispose existing tooltips first
        const existingTooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        existingTooltips.forEach(el => {
            const tooltipInstance = bootstrap.Tooltip.getInstance(el);
            if (tooltipInstance) {
                tooltipInstance.dispose();
            }
        });
        // Initialize new ones
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                 delay: { "show": 100, "hide": 100 },
                 trigger : 'hover focus',
                 // Attempt to attach to body to avoid issues within complex containers like modals/accordions
                 container: 'body'
             });
        });
      }
      initializeTooltips();
      window.initializeTooltips = initializeTooltips; // Make it accessible globally

      initPlaceholderGenerator();

       // Reinitialize tooltips when accordion is shown/hidden (might reveal/hide tooltips)
       const accordionElement = document.getElementById('howtoCollapse');
       if (accordionElement) {
           accordionElement.addEventListener('shown.bs.collapse', window.initializeTooltips);
           accordionElement.addEventListener('hidden.bs.collapse', window.initializeTooltips);
       }
    });

    // Variáveis globais
    let template = "";
    const placeholders = new Set(); // Set of unique placeholder keys (e.g., "Nome Cliente", "Data Vencimento")
    const formattedPlaceholders = new Map(); // Maps key to its FULL format string (e.g., "Data Vencimento" -> "datahoje.add(6M)")
    const placeholderHelps = new Map(); // Maps key to its help text (e.g., "CPF" -> "Digite apenas os números")

    // Regex
    const formatRegex = /\{\[([^\|\]]+)(?:\|([^\]]+))?\]\.([a-zA-Z0-9\.\(\)]+)\}/g; // {[Key|Help].format1.format2}
    const simpleRegex = /\[([^\|\]]+)(?:\|([^\]]+))?\]/g; // [Key|Help]

    // --- Funções Auxiliares de Data (sem alterações) ---
    function formatarDataDescritiva(date) { /* ... */
        if (!(date instanceof Date) || isNaN(date)) return '';
        const dia = date.getDate();
        const mes = date.toLocaleDateString('pt-BR', { month: 'long' });
        const ano = date.getFullYear();
        return `${dia} de ${mes} de ${ano}`;
    }
    function formatarDataHoje() { return formatarDataDescritiva(new Date()); }
    function formatarDataPadrao(date) { /* ... */
        if (!(date instanceof Date) || isNaN(date)) return '';
        const dia = String(date.getDate()).padStart(2, '0');
        const mes = String(date.getMonth() + 1).padStart(2, '0');
        const ano = date.getFullYear();
        return `${dia}/${mes}/${ano}`;
    }
    function applyDateAdd(date, instruction) { /* ... */
        if (!(date instanceof Date) || isNaN(date)) return date;
        const match = instruction.match(/add\((\d+)\s*([DMA])\)/i);
        if (!match) return date;
        const value = parseInt(match[1], 10);
        const unit = match[2].toUpperCase();
        const newDate = new Date(date.getTime());
        try {
            switch (unit) {
                case 'D': newDate.setDate(newDate.getDate() + value); break;
                case 'M': newDate.setMonth(newDate.getMonth() + value); break;
                case 'A': newDate.setFullYear(newDate.getFullYear() + value); break;
                default: return date;
            }
            if (isNaN(newDate)) return date;
            return newDate;
        } catch (e) { return date; }
    }

    // --- Função numeroParaExtenso (sem alterações) ---
    function numeroParaExtenso(numero) { /* ... (Omitida para brevidade) ... */
        if (isNaN(numero)) return numero;
        const unidades = ['', 'um', 'dois', 'três', 'quatro', 'cinco', 'seis', 'sete', 'oito', 'nove', 'dez', 'onze', 'doze', 'treze', 'quatorze', 'quinze', 'dezesseis', 'dezessete', 'dezoito', 'dezenove'];
        const dezenas = ['', '', 'vinte', 'trinta', 'quarenta', 'cinquenta', 'sessenta', 'setenta', 'oitenta', 'noventa'];
        const centenas = ['', 'cento', 'duzentos', 'trezentos', 'quatrocentos', 'quinhentos', 'seiscentos', 'setecentos', 'oitocentos', 'novecentos'];
        const milhares = ['', 'mil', 'milhão', 'bilhão', 'trilhão'];
        const milharesPlural = ['', 'mil', 'milhões', 'bilhões', 'trilhões'];
        function converterGrupo(n) {
            let resultado = ''; if (n === 0) return '';
            if (n >= 100) { const c = Math.floor(n / 100); if (n === 100) { resultado = 'cem'; } else { resultado = centenas[c]; if (n % 100 !== 0) { resultado += ' e '; } } n %= 100; }
            if (n > 0) { if (n < 20) { resultado += unidades[n]; } else { resultado += dezenas[Math.floor(n / 10)]; if (n % 10 !== 0) { resultado += ' e ' + unidades[n % 10]; } } } return resultado;
        }
        if (numero === 0) return 'zero reais'; const negativo = numero < 0; numero = Math.abs(numero);
        const numStr = numero.toFixed(2).toString(); const partes = numStr.split('.'); let parteInteira = parseInt(partes[0]); const parteDecimal = parseInt(partes[1]);
        let resultado = ''; let grupo = 0;
        if (parteInteira === 0 && parteDecimal > 0) {} else if (parteInteira === 1) { resultado = 'um'; } else { while (parteInteira > 0) { const tres = parteInteira % 1000; if (tres !== 0) { const textoGrupo = converterGrupo(tres); const nomeGrupo = grupo > 0 ? (tres === 1 ? milhares[grupo] : milharesPlural[grupo]) : ''; resultado = textoGrupo + (nomeGrupo ? ' ' + nomeGrupo : '') + (resultado ? (tres === 100 || tres % 100 === 0 || parteInteira < 1000 ? ' e ' : ', ') + resultado : ''); } parteInteira = Math.floor(parteInteira / 1000); grupo++; } }
        if (parseInt(partes[0]) === 1) { resultado += ' real'; } else if (parseInt(partes[0]) > 1 || (parseInt(partes[0]) === 0 && parteDecimal === 0) ) { resultado += ' reais'; }
        if (parteDecimal > 0) { const textoDecimal = converterGrupo(parteDecimal); if (parseInt(partes[0]) > 0) { resultado += ' e '; } resultado += textoDecimal + (parteDecimal === 1 ? ' centavo' : ' centavos'); } else if (parseInt(partes[0]) === 0 && parteDecimal === 0) {}
        if (negativo) { resultado = 'menos ' + resultado; }
        resultado = resultado.replace(/^ e /,'').replace(/ e $/,'').trim(); return resultado;
    }

    // --- Funções de Formatação (Aplicadas na Geração - sem alterações) ---
    const formatters = {
      maiusculo: (text) => String(text).toUpperCase(),
      minusculo: (text) => String(text).toLowerCase(),
      capitalizado: (text) => String(text).split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' '),
      telefone: (text) => { const n = String(text).replace(/\D/g,''); if(n.length===11) return `(${n.slice(0,2)}) ${n.slice(2,7)}-${n.slice(7)}`; if(n.length===10) return `(${n.slice(0,2)}) ${n.slice(2,6)}-${n.slice(6)}`; return text; },
      cpf: (text) => { const n = String(text).replace(/\D/g,''); if(n.length===11) return `${n.slice(0,3)}.${n.slice(3,6)}.${n.slice(6,9)}-${n.slice(9)}`; return text; },
      cnpj: (text) => { const n = String(text).replace(/\D/g,''); if(n.length===14) return `${n.slice(0,2)}.${n.slice(2,5)}.${n.slice(5,8)}/${n.slice(8,12)}-${n.slice(12)}`; return text; },
      cpfcnpj: (text) => { const n = String(text).replace(/\D/g,''); if(n.length===11) return formatters.cpf(n); if(n.length===14) return formatters.cnpj(n); return text; },
      cep: (text) => { const n = String(text).replace(/\D/g,''); if(n.length===8) return `${n.slice(0,5)}-${n.slice(5)}`; return text; },
      data: (text) => { try { const d=new Date(text); if(!isNaN(d) && String(text).match(/[0-9]/)) return formatarDataPadrao(d); } catch(e){} return text; },
      moeda: (text) => { const c = String(text).replace(/[^0-9,.-]/g, ''); let v = c.replace(/[.,](?=[^.,]*[.,])/g, '').replace(',', '.'); const n = parseFloat(v); if(!isNaN(n)) return n.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); return text; },
      valorextenso: (text) => { const c = String(text).replace(/[^0-9,.-]/g, ''); let v = c.replace(/[.,](?=[^.,]*[.,])/g, '').replace(',', '.'); const n = parseFloat(v); if(!isNaN(n)) return numeroParaExtenso(n); return text; }
    };

    // --- Drag and Drop / File Handling (sem alterações) ---
    const dropArea = document.getElementById('dropArea'); /* ... (Omitido para brevidade) ... */
    const fileInput = document.getElementById('fileInput');
    const browseButton = document.getElementById('browseButton');
    browseButton.addEventListener('click', () => { fileInput.click(); });
    dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('bg-light'); });
    dropArea.addEventListener('dragleave', () => { dropArea.classList.remove('bg-light'); });
    dropArea.addEventListener('drop', (e) => { e.preventDefault(); dropArea.classList.remove('bg-light'); if (e.dataTransfer.files.length) { fileInput.files = e.dataTransfer.files; handleFileSelect(e.dataTransfer.files[0]); } });
    fileInput.addEventListener('change', (event) => { if (event.target.files.length) handleFileSelect(event.target.files[0]); });
    function handleFileSelect(file) { /* ... (Omitido para brevidade) ... */
        if (file && file.name.toLowerCase().endsWith('.md')) {
            const reader = new FileReader();
            reader.onload = function (e) {
                template = e.target.result; console.log("Arquivo carregado:", template.substring(0,100)+"...");
                const dropArea = document.getElementById('dropArea');
                dropArea.innerHTML = `<i class="fas fa-check-circle upload-icon" style="color: green;"></i><h5>Arquivo carregado!</h5><p class="text-muted">${file.name}</p><button class="btn btn-outline-primary mt-2" id="changeFileBtn"><i class="fas fa-exchange-alt me-2"></i>Trocar</button>`;
                document.getElementById('changeFileBtn').addEventListener('click', () => { location.reload(); });
                extractPlaceholders(template); updatePlaceholderLists();
            }; reader.onerror = function() { console.error("Erro ao ler."); alert("Erro ao ler arquivo."); }; reader.readAsText(file);
        } else { alert('Selecione um arquivo Markdown (.md)'); }
    }

    // --- Extração de Placeholders (sem alterações na lógica de extração) ---
    function extractPlaceholders(text) { /* ... (Omitido para brevidade - lógica igual à anterior) ... */
        placeholders.clear(); formattedPlaceholders.clear(); placeholderHelps.clear();
        const dynamicFields = document.getElementById('dynamicFields'); dynamicFields.innerHTML = '';
        const uniqueKeys = new Set();
        const formatRegexCopy = new RegExp(formatRegex.source, 'g'); let formatMatch;
        while ((formatMatch = formatRegexCopy.exec(text)) !== null) {
            const key = formatMatch[1].trim(); const help = formatMatch[2] ? formatMatch[2].trim() : ''; const formatString = formatMatch[3].trim();
            formattedPlaceholders.set(key, formatString); if (help) placeholderHelps.set(key, help);
            if (!uniqueKeys.has(key)) { placeholders.add(key); uniqueKeys.add(key); createField(key, formatString, dynamicFields); }
        }
        const simpleRegexCopy = new RegExp(simpleRegex.source, 'g'); let simpleMatch;
        while ((simpleMatch = simpleRegexCopy.exec(text)) !== null) {
            const key = simpleMatch[1].trim(); const help = simpleMatch[2] ? simpleMatch[2].trim() : '';
            if (!formattedPlaceholders.has(key) && !uniqueKeys.has(key)) { placeholders.add(key); uniqueKeys.add(key); createField(key, null, dynamicFields); }
            if (help && !placeholderHelps.has(key)) {
                 placeholderHelps.set(key, help); const inputEl = document.getElementById(`field_${key.replace(/\s+/g, '_')}`);
                 if(inputEl && !inputEl.placeholder) inputEl.placeholder = help;
                 const helpIcon = inputEl?.previousElementSibling?.querySelector('.fa-question-circle');
                 if (helpIcon && !helpIcon.getAttribute('data-bs-original-title')) { helpIcon.setAttribute('title', help); helpIcon.setAttribute('data-bs-original-title', help); }
            }
        }
        console.log("Keys:", [...placeholders]); console.log("Formatos:", [...formattedPlaceholders]); console.log("Ajudas:", [...placeholderHelps]);
        if (placeholders.size > 0) { document.getElementById('formFields').classList.remove('hidden'); setTimeout(() => { if (window.initializeTooltips) window.initializeTooltips(); }, 150); }
        else { if(template) alert('Nenhum campo [Campo] ou {[Campo].formato} encontrado.'); document.getElementById('formFields').classList.add('hidden'); }
    }


    // --- Criação de Campos Dinâmicos (sem alterações na lógica) ---
    function createField(key, formatString, container) { /* ... (Omitido para brevidade - lógica igual à anterior) ... */
        const fieldId = `field_${key.replace(/\s+/g, '_')}`; if (document.getElementById(fieldId)) return;
        const fieldGroup = document.createElement('div'); fieldGroup.className = 'mb-3';
        const label = document.createElement('label'); label.className = 'form-label'; label.htmlFor = fieldId;
        const labelText = document.createElement('span'); labelText.textContent = key + ':'; label.appendChild(labelText);
        const input = document.createElement('input'); input.type = 'text'; input.className = 'form-control'; input.id = fieldId; input.name = key;
        let tooltipText = placeholderHelps.get(key) || ''; let prefilledValue = ''; let isDateField = false; let primaryFormat = formatString ? formatString.split('.')[0] : null;
        if (formatString && (formatString.startsWith('datahoje') || formatString.includes('.datahoje.'))) {
             isDateField = true; let calculatedDate = new Date(); const formats = formatString.split('.');
             for (const format of formats) { if (format.startsWith('add(')) { calculatedDate = applyDateAdd(calculatedDate, format); if(isNaN(calculatedDate)) {calculatedDate = new Date(); break; } } }
             prefilledValue = formatarDataDescritiva(calculatedDate);
        }
        if (prefilledValue) { input.value = prefilledValue; input.placeholder = placeholderHelps.get(key) || `Data pré-preenchida (editável)`; }
        else if (placeholderHelps.has(key)) { input.placeholder = placeholderHelps.get(key); }
        else { switch (primaryFormat) { /* ... placeholders padrão ... */ } }
        const hasFormatOrHelp = formatString || placeholderHelps.has(key);
        if (hasFormatOrHelp) {
            const infoIcon = document.createElement('i'); infoIcon.className = `fas ${formatString ? 'fa-info-circle' : 'fa-question-circle'} info-icon ms-1`; infoIcon.setAttribute('data-bs-toggle', 'tooltip'); infoIcon.setAttribute('data-bs-placement', 'top');
            let dynamicHelp = '';
            if (isDateField) { dynamicHelp = `Pré-preenchido (${prefilledValue}). Editável.`; const others = formatString.split('.').filter(f=>!f.startsWith('datahoje')&&!f.startsWith('add')).join(', '); if(others) dynamicHelp += ` Formatos (${others}) aplicados na geração.` }
            else if (formatString) { dynamicHelp = `Formato "${formatString}" aplicado na geração.`; }
            tooltipText = [placeholderHelps.get(key), dynamicHelp].filter(Boolean).join(' | '); infoIcon.setAttribute('title', tooltipText || 'Info'); label.appendChild(infoIcon);
        }
        fieldGroup.appendChild(label); fieldGroup.appendChild(input); container.appendChild(fieldGroup);
    }


    // --- Processamento do Formulário (MODIFICADO para corrigir duplicados) ---
    document.getElementById('formFields').addEventListener('submit', function (event) {
      event.preventDefault();
      let filledText = template; // Começa com o template original a cada submit

      // --- Substituição de Placeholders ---

      // 1. Processa placeholders formatados/com operações {[...].formato}
      const processedFormatted = new Set(); // Rastreia fullMatch processados
      const formatRegexCopy = new RegExp(formatRegex.source, 'g');
      let formatMatch;
      while ((formatMatch = formatRegexCopy.exec(template)) !== null) {
        const fullMatch = formatMatch[0]; // Ex: {[Data Início|Ajuda].datahoje}
        if (processedFormatted.has(fullMatch)) continue; // Evita reprocessar a mesma string exata

        const key = formatMatch[1].trim(); // Ex: "Data Início"
        const formatString = formatMatch[3].trim(); // Ex: "datahoje"
        const inputElement = document.getElementById(`field_${key.replace(/\s+/g, '_')}`);
        let finalValue = inputElement ? inputElement.value : ""; // Valor ATUAL do input

        const formats = formatString.split('.');

        // Aplica APENAS formatadores (NÃO datahoje/add) ao valor do campo
        for (const format of formats) {
            const currentFormat = format.trim();
            if (currentFormat === 'datahoje' || currentFormat.startsWith('add(')) continue; // Pula pré-preenchedores
            if (formatters[currentFormat]) {
                 try { finalValue = formatters[currentFormat](finalValue); }
                 catch (e) { console.error(`Erro formatando ${key}.${currentFormat}:`, e); }
            } else if (currentFormat) { console.warn(`Formato desconhecido: ${currentFormat}`); }
        }

        // Substitui TODAS as ocorrências da string formatada original
        filledText = filledText.replaceAll(fullMatch, () => finalValue); // Usa função para evitar problemas com $
        processedFormatted.add(fullMatch);
      }


      // 2. Processa placeholders simples [Campo] ou [Campo|Ajuda]
      const simpleRegexCopy = new RegExp(simpleRegex.source, 'g');
      let simpleMatch;
      while ((simpleMatch = simpleRegexCopy.exec(template)) !== null) {
        const fullMatch = simpleMatch[0]; // Ex: [Data início]
        const key = simpleMatch[1].trim(); // Ex: "Data início"

        // *** CORREÇÃO: Não verifica mais se a key existe em formattedPlaceholders ***
        // Sempre busca o valor do input correspondente e substitui a string simples.
        const inputElement = document.getElementById(`field_${key.replace(/\s+/g, '_')}`);
        const value = inputElement ? inputElement.value : ""; // Pega valor ATUAL do input

        // Substitui TODAS as ocorrências da string simples original
        // Importante: Faz replace em `filledText`, que já pode ter tido replaces anteriores
        filledText = filledText.replaceAll(fullMatch, () => value);
      }


      // --- Renderiza o resultado ---
      const html = marked.parse(filledText); /* ... (renderização igual) ... */
      const font = document.getElementById('fontFamily').value;
      const size = document.getElementById('fontSize').value;
      const mode = document.getElementById('outputMode').value;
      const preview = document.getElementById('preview');
      preview.innerHTML = html; preview.style.fontFamily = font; preview.style.fontSize = size;
      document.getElementById('previewContainer').classList.remove('hidden');
      if (mode === 'print') { printDocument(html, font, size); }
      document.getElementById('previewContainer').scrollIntoView({ behavior: 'smooth' });
    });

    // --- Botão de Impressão e Função printDocument (sem alterações) ---
    document.getElementById('printPreviewBtn').addEventListener('click', function() { /* ... */
        const html = document.getElementById('preview').innerHTML; const font = document.getElementById('fontFamily').value; const size = document.getElementById('fontSize').value; printDocument(html, font, size);
    });
    function printDocument(html, font, size) { /* ... (Omitido para brevidade) ... */
        const printWindow = window.open('', '', 'width=800,height=600');
        printWindow.document.write(`<!DOCTYPE html><html lang="pt-br"><head><meta charset="UTF-8"><title>Imprimir</title><style>body{font-family:${font};font-size:${size};line-height:1.6;padding:40px;max-width:800px;margin:0 auto;} @media print{body{padding:0;margin:0;} p,h1,h2,h3,h4,h5,h6,li,blockquote{page-break-inside:avoid;} h1,h2,h3,h4,h5,h6{page-break-before:auto;page-break-after:avoid;}}</style></head><body>${html}</body></html>`);
        printWindow.document.close(); setTimeout(() => { try { printWindow.focus(); printWindow.print(); } catch (e) { console.error("Erro print:", e); alert("Erro imprimir."); } }, 500);
    }

    // --- Gerador de Placeholders no Modal (sem alterações na lógica) ---
    function initPlaceholderGenerator() { /* ... (Omitido para brevidade - lógica igual à anterior) ... */
        const typeRadios = document.querySelectorAll('input[name="placeholderType"]'); const formatOptions = document.getElementById('formatOptions'); const placeholderPreview = document.getElementById('placeholderPreview'); const newPlaceholderName = document.getElementById('newPlaceholderName'); const newPlaceholderHelp = document.getElementById('newPlaceholderHelp'); const placeholderFormat = document.getElementById('placeholderFormat'); const copyNewPlaceholder = document.getElementById('copyNewPlaceholder'); const formatNote = document.getElementById('formatNote');
        typeRadios.forEach(radio => radio.addEventListener('change', updatePlaceholderPreview)); newPlaceholderName.addEventListener('input', updatePlaceholderPreview); newPlaceholderHelp.addEventListener('input', updatePlaceholderPreview); placeholderFormat.addEventListener('change', updatePlaceholderPreview);
        document.getElementById('typeFormatted').addEventListener('change', function() { formatOptions.classList.remove('d-none'); updatePlaceholderPreview(); });
        document.getElementById('typePlain').addEventListener('change', function() { formatOptions.classList.add('d-none'); updatePlaceholderPreview(); });
        function updatePlaceholderPreview() { const name = newPlaceholderName.value.trim() || 'Nome Campo'; const help = newPlaceholderHelp.value.trim(); const type = document.querySelector('input[name="placeholderType"]:checked').value; const selectedOption = placeholderFormat.options[placeholderFormat.selectedIndex]; const formatValue = selectedOption ? selectedOption.value : ''; const formatType = selectedOption ? selectedOption.getAttribute('data-type') : '';
            if (formatType === 'prefill' && type === 'formatted') { formatNote.textContent = `Pré-preenche ${name} com data (editável).`; formatNote.classList.remove('d-none'); } else if (type === 'formatted' && formatValue) { formatNote.textContent = `Formato "${formatValue.split(' - ')[0]}" aplicado na geração.`; formatNote.classList.remove('d-none'); } else { formatNote.classList.add('d-none'); formatNote.textContent = ''; }
            if (type === 'plain') { placeholderPreview.textContent = help ? `[${name}|${help}]` : `[${name}]`; } else { let baseFormat = formatValue || 'operação'; baseFormat = baseFormat.split(' - ')[0].trim(); placeholderPreview.textContent = help ? `{[${name}|${help}].${baseFormat}}` : `{[${name}].${baseFormat}}`; }
        }
        copyNewPlaceholder.addEventListener('click', function() { const textToCopy = placeholderPreview.textContent; navigator.clipboard.writeText(textToCopy).then(() => { const o = copyNewPlaceholder.innerHTML; copyNewPlaceholder.innerHTML = '<i class="fas fa-check"></i> Copiado!'; copyNewPlaceholder.classList.add('btn-success'); copyNewPlaceholder.classList.remove('btn-primary'); setTimeout(() => { copyNewPlaceholder.innerHTML = o; copyNewPlaceholder.classList.remove('btn-success'); copyNewPlaceholder.classList.add('btn-primary'); }, 2000); }).catch(err => { console.error('Erro copy: ', err); alert('Erro copiar.'); }); });
        updatePlaceholderPreview();
    }

    // --- Atualização das Listas de Placeholders no Modal (sem alterações na lógica) ---
    function updatePlaceholderLists() { /* ... (Omitido para brevidade - lógica igual à anterior) ... */
        const simpleList = document.getElementById('simplePlaceholderList'); const dateOpsList = document.getElementById('dateOpsPlaceholderList'); const textNumList = document.getElementById('textNumPlaceholderList'); const noSimpleMsg = document.getElementById('noSimplePlaceholders'); const noFormattedMsg = document.getElementById('noFormattedPlaceholders');
        simpleList.innerHTML = ''; dateOpsList.innerHTML = ''; textNumList.innerHTML = ''; let simpleCount = 0; let formattedCount = 0; let dateOpCount = 0; let textNumCount = 0;
        const createListItem = (key, fullPlaceholderSyntax, targetList) => { const i = document.createElement('div'); i.className = 'placeholder-item'; const t = document.createElement('span'); t.textContent = fullPlaceholderSyntax; const c = document.createElement('button'); c.className = 'copy-btn'; c.innerHTML = '<i class="fas fa-copy"></i>'; c.title = 'Copiar'; c.addEventListener('click', () => { navigator.clipboard.writeText(t.textContent).then(() => { c.innerHTML = '<i class="fas fa-check"></i>'; setTimeout(() => { c.innerHTML = '<i class="fas fa-copy"></i>'; }, 1500); }); }); i.appendChild(t); i.appendChild(c); targetList.appendChild(i); };
        placeholders.forEach(key => { const help = placeholderHelps.get(key) || ''; const formatString = formattedPlaceholders.get(key);
            if (formatString) { formattedCount++; const fullSyntax = help ? `{[${key}|${help}].${formatString}}` : `{[${key}].${formatString}}`; if (formatString.includes('datahoje') || formatString.includes('add(')) { dateOpCount++; createListItem(key, fullSyntax, dateOpsList); } else { textNumCount++; createListItem(key, fullSyntax, textNumList); } }
            else { simpleCount++; const fullSyntax = help ? `[${key}|${help}]` : `[${key}]`; createListItem(key, fullSyntax, simpleList); }
        });
        noSimpleMsg?.remove(); noFormattedMsg?.remove(); if (simpleCount === 0) simpleList.appendChild(noSimpleMsg);
        if (formattedCount === 0) { document.getElementById('formattedPlaceholderList').appendChild(noFormattedMsg); } else { if(dateOpCount === 0) dateOpsList.innerHTML = '<p class="text-muted small ps-1">Nenhum pré-preenchimento encontrado.</p>'; if(textNumCount === 0) textNumList.innerHTML = '<p class="text-muted small ps-1">Nenhuma formatação encontrada.</p>'; }
    }


    // Atualiza lista do modal quando ele é aberto
    document.getElementById('placeholderModal').addEventListener('show.bs.modal', function () {
       if(template && placeholders.size === 0) { extractPlaceholders(template); }
       updatePlaceholderLists();
       // Reinitialize tooltips within the modal after content update
       setTimeout(() => { if (window.initializeTooltips) window.initializeTooltips(); }, 150);
    });

  </script>
</body>
</html>